name: Deploy PR Previews

concurrency: preview-${{ github.ref }}

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/build-docs.yml'
      - '.github/workflows/preview-docs.yml'

jobs:
  build-docs:
    if: github.event.action != 'closed'
    uses: ./.github/workflows/build-docs.yml

  deploy-preview:
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.event.action != 'closed'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download docs artifact
        uses: actions/download-artifact@v4
        with:
          name: docs
          path: site

      - name: Ensure .nojekyll exists at gh-pages root
        run: |
          # Check if gh-pages branch exists
          if git ls-remote --exit-code --heads origin gh-pages; then
            git fetch origin gh-pages:gh-pages
            # Check if .nojekyll exists
            if ! git show gh-pages:.nojekyll &>/dev/null; then
              echo "Creating .nojekyll at gh-pages root"
              git checkout gh-pages
              touch .nojekyll
              git add .nojekyll
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git commit -m "Add .nojekyll to disable Jekyll processing"
              git push origin gh-pages
              git checkout -
            fi
          fi

      - name: Deploy preview
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: site
          preview-branch: gh-pages
          umbrella-dir: pr-preview
          action: auto

  cleanup-preview:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup preview
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: site
          preview-branch: gh-pages
          umbrella-dir: pr-preview
          action: remove

  comment-on-pr:
    runs-on: ubuntu-latest
    needs: deploy-preview
    if: github.event.action != 'closed'
    permissions:
      pull-requests: write

    steps:
      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: Documentation Preview

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## Documentation Preview

            A preview of the documentation changes is available at:

            **[View Preview](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-preview/pr-${{ github.event.pull_request.number }}/)**

            ---
            <sub>Built from commit ${{ github.sha }}</sub>
