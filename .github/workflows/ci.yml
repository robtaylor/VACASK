name: CI

on:
  push:
    branches: [main, macos-fixes]
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            name: Ubuntu 24.04
          - os: ubuntu-22.04
            name: Ubuntu 22.04
          - os: macos-14
            name: macOS

    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install LLVM 18 (Ubuntu 22.04)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          # Ubuntu 22.04 has LLVM 14 by default, but OpenVAF requires LLVM 18+
          # Install LLVM 18 from official apt.llvm.org repository
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
          echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-18 main" | sudo tee /etc/apt/sources.list.d/llvm-18.list
          sudo apt-get update
          sudo apt-get install -y llvm-18-dev libclang-18-dev clang-18 lld-18
          # Set up alternatives so llvm tools point to version 18
          sudo update-alternatives --install /usr/bin/llvm-config llvm-config /usr/bin/llvm-config-18 100
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
          # Add LLVM 18 bin directory to PATH for tools like llvm-lib
          echo "/usr/lib/llvm-18/bin" >> "$GITHUB_PATH"
          echo "LLVM_SYS_180_PREFIX=/usr/lib/llvm-18" >> "$GITHUB_ENV"

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            bison \
            flex \
            libfl-dev \
            libsuitesparse-dev \
            python3 \
            python3-numpy \
            python3-scipy
          # Install default LLVM on Ubuntu 24.04 (which has LLVM 18+)
          if [ "${{ matrix.os }}" != "ubuntu-22.04" ]; then
            sudo apt-get install -y llvm-dev libclang-dev clang
          fi

      - name: Install toml++ (Linux)
        if: runner.os == 'Linux'
        run: |
          # toml++ is header-only, install from source
          cd /tmp
          curl -L -o tomlplusplus.tar.gz https://github.com/marzer/tomlplusplus/archive/refs/tags/v3.4.0.tar.gz
          tar xzf tomlplusplus.tar.gz
          sudo mkdir -p /usr/local/include
          sudo cp -r tomlplusplus-3.4.0/include/toml++ /usr/local/include/
          echo "TOMLPP_DIR=/usr/local" >> "$GITHUB_ENV"

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install \
            cmake \
            ninja \
            bison \
            flex \
            suite-sparse \
            boost \
            tomlplusplus \
            llvm \
            python3 \
            numpy \
            scipy

      - name: Build Boost 1.88 (Linux)
        if: runner.os == 'Linux'
        run: |
          # VACASK requires Boost 1.88 with process component
          # Install Boost and create symlink for VACASK's expected layout
          cd /tmp
          curl -L -o boost.tar.gz https://github.com/boostorg/boost/releases/download/boost-1.88.0/boost-1.88.0-b2-nodocs.tar.gz
          tar xzf boost.tar.gz
          cd boost-1.88.0
          ./bootstrap.sh --with-libraries=filesystem,process,system --prefix=/tmp/boost-install
          ./b2 "-j$(nproc)" variant=release link=static,shared threading=multi install
          # VACASK expects libs at Boost_INCLUDE_DIR/stage/lib, create symlink
          mkdir -p /tmp/boost-install/include/stage
          ln -s /tmp/boost-install/lib /tmp/boost-install/include/stage/lib
          echo "BOOST_ROOT=/tmp/boost-install" >> "$GITHUB_ENV"
          echo "CMAKE_PREFIX_PATH=/tmp/boost-install" >> "$GITHUB_ENV"

      - name: Cache OpenVAF build
        id: cache-openvaf
        uses: actions/cache@v4
        with:
          path: ~/.openvaf
          key: openvaf-${{ matrix.os }}-${{ runner.arch }}-v3

      - name: Build OpenVAF-reloaded
        if: steps.cache-openvaf.outputs.cache-hit != 'true'
        run: |
          # Install Rust
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal
          # shellcheck source=/dev/null
          source ~/.cargo/env

          # Clone OpenVAF from arpadbuermen fork with macOS patches
          git clone --branch branches/macos-patches-v3 https://github.com/arpadbuermen/OpenVAF.git /tmp/openvaf
          cd /tmp/openvaf

          # Set LLVM environment based on OS
          if [ "$RUNNER_OS" == "macOS" ]; then
            BREW_PREFIX="$(brew --prefix)"
            export LLVM_SYS_210_PREFIX="$BREW_PREFIX/opt/llvm"
            export PATH="$BREW_PREFIX/opt/llvm/bin:$PATH"
            LLVM_FEATURE="llvm21"
          else
            # Linux: use system LLVM (version varies by Ubuntu version)
            # OpenVAF requires LLVM 18+ (supported features: llvm18, llvm19, llvm20, llvm21)
            LLVM_VERSION=$(llvm-config --version | cut -d. -f1)
            echo "Detected LLVM version: $LLVM_VERSION"
            LLVM_FEATURE="llvm${LLVM_VERSION}"
          fi

          echo "Building with feature: $LLVM_FEATURE"
          cargo build --release --features "$LLVM_FEATURE" --bin openvaf-r

          # Install to cache location
          mkdir -p ~/.openvaf
          cp target/release/openvaf-r ~/.openvaf/

      - name: Setup OpenVAF path
        run: |
          chmod +x "$HOME/.openvaf/openvaf-r"
          echo "OPENVAF_DIR=$HOME/.openvaf" >> "$GITHUB_ENV"

      - name: Configure VACASK
        run: |
          CMAKE_ARGS=(-G Ninja -S . -B build -DCMAKE_BUILD_TYPE=Release)
          CMAKE_ARGS+=("-DOPENVAF_DIR=$OPENVAF_DIR")

          if [ "$RUNNER_OS" == "macOS" ]; then
            BREW_PREFIX="$(brew --prefix)"
            CMAKE_ARGS+=("-DSuiteSparse_DIR=$BREW_PREFIX/opt/suite-sparse")
            CMAKE_ARGS+=("-DTOMLPP_DIR=$BREW_PREFIX/opt/tomlplusplus")
            # Find Boost cmake config directory
            BOOST_CMAKE_DIR="$(find "$BREW_PREFIX/opt/boost/lib/cmake" -maxdepth 1 -name 'boost_*' -o -name 'Boost*' 2>/dev/null | head -1)"
            if [ -z "$BOOST_CMAKE_DIR" ]; then
              BOOST_CMAKE_DIR="$BREW_PREFIX/opt/boost/lib/cmake"
            fi
            CMAKE_ARGS+=("-DCMAKE_PREFIX_PATH=$BREW_PREFIX/opt/boost")
            CMAKE_ARGS+=("-DBoost_DIR=$BOOST_CMAKE_DIR")
            CMAKE_ARGS+=("-DBISON_EXECUTABLE=$BREW_PREFIX/opt/bison/bin/bison")
            CMAKE_ARGS+=("-DFLEX_INCLUDE_DIR=$BREW_PREFIX/opt/flex/include")
          else
            CMAKE_ARGS+=("-DBoost_ROOT=$BOOST_ROOT")
            CMAKE_ARGS+=("-DCMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH")
            CMAKE_ARGS+=("-DSuiteSparse_DIR=/usr")
            CMAKE_ARGS+=("-DTOMLPP_DIR=$TOMLPP_DIR")
          fi

          echo "Running: cmake ${CMAKE_ARGS[*]}"
          cmake "${CMAKE_ARGS[@]}"

      - name: Build VACASK
        run: |
          cmake --build build "-j$(nproc 2>/dev/null || sysctl -n hw.ncpu)"

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure --timeout 60

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vacask-${{ matrix.os }}
          path: |
            build/simulator/vacask
            build/lib/*.osdi
          if-no-files-found: warn
